const socket = require("socket.io");
const express = require("express");
const lodash = require("lodash");
const PORT = 3000;

//set up server
const app = express();
const server = app.listen(PORT, () => {
     console.log(`Listening on port ${PORT}...`);
});


const usersMap = {};
const rooms = {};

const log = () => {
     console.log("@@@ LOG: ", JSON.stringify({
          usersMap,
          rooms,
     }, null, 3));
}

var room = "chatRoom";
//set up io
const io = socket(server);
io.on("connect", (socket) => {
     // console.log(socket.id, "connected");

     socket.on("request_join", (room) => {
          console.log(`${socket.id} requests to join ${room}`)

          if (!rooms[room]) {
               rooms[room] = []
          } else {
               rooms[room].push(socket.id);
          }
          socket.join(room)
          socket.to(room).emit("back", `Room ${room} has new user: ${socket.id}`);
          usersMap[socket.id] = room
     });


     const handleDataChange = lodash.debounce((res) => {
          console.log('on data change', res.length)
          socket.emit("server_data", JSON.stringify(res));
     }, 100)

     socket.on("device_data", handleDataChange)

     // socket.on("on_submit", (res) => {
     //      console.log('here');
     //      debounceEmitter(socket, res)
     // })

     socket.on("disconnect", (socket) => {
          // console.log("User left");
     });
});

const debounceEmitter = lodash.debounce((socket, res) => {
     console.log("on_submit", JSON.stringify(res, null, 2));
     socket.emit("on_receive", JSON.stringify(res, null, 2));
}, 1000)
const test = [
     [
          {
               "x": 420.4161,
               "y": 296.51602
          },
          {
               "x": 418.88943,
               "y": 309.9192
          },
          {
               "x": 417.34387,
               "y": 328.61096
          },
          {
               "x": 414.15384,
               "y": 353.76477
          },
          {
               "x": 411.0243,
               "y": 381.21924
          },
          {
               "x": 407.1588,
               "y": 412.2398
          },
          {
               "x": 401.1644,
               "y": 449.19324
          },
          {
               "x": 395.94968,
               "y": 492.24146
          },
          {
               "x": 389.70984,
               "y": 538.5695
          },
          {
               "x": 384.4631,
               "y": 594.4369
          },
          {
               "x": 383.57547,
               "y": 661.18304
          },
          {
               "x": 385.46466,
               "y": 701.82513
          }
     ],
     [
          {
               "x": 435.3953,
               "y": 246.68073
          },
          {
               "x": 433.39807,
               "y": 248.14926
          },
          {
               "x": 431.3469,
               "y": 248.73315
          },
          {
               "x": 429.7943,
               "y": 249.28745
          },
          {
               "x": 428.23828,
               "y": 250.84439
          },
          {
               "x": 425.69357,
               "y": 252.39145
          },
          {
               "x": 424.142,
               "y": 252.67603
          },
          {
               "x": 422.56796,
               "y": 253.67526
          },
          {
               "x": 419.636,
               "y": 256.45428
          },
          {
               "x": 417.46503,
               "y": 257.62735
          },
          {
               "x": 415.9223,
               "y": 260.6698
          },
          {
               "x": 411.27658,
               "y": 261.8211
          },
          {
               "x": 409.43137,
               "y": 264.29843
          },
          {
               "x": 407.0671,
               "y": 267.03235
          },
          {
               "x": 403.93777,
               "y": 269.16434
          },
          {
               "x": 402.1442,
               "y": 272.2553
          },
          {
               "x": 397.71713,
               "y": 275.38876
          },
          {
               "x": 394.60364,
               "y": 278.50418
          },
          {
               "x": 392.47363,
               "y": 282.6339
          },
          {
               "x": 389.37027,
               "y": 286.2832
          },
          {
               "x": 387.3565,
               "y": 290.9626
          },
          {
               "x": 384.14758,
               "y": 295.62082
          },
          {
               "x": 381.03714,
               "y": 301.5052
          },
          {
               "x": 377.8956,
               "y": 306.79285
          },
          {
               "x": 374.78622,
               "y": 311.66983
          },
          {
               "x": 372.57346,
               "y": 316.44437
          },
          {
               "x": 369.57584,
               "y": 322.44327
          },
          {
               "x": 366.43958,
               "y": 326.72113
          },
          {
               "x": 364.3324,
               "y": 331.35693
          },
          {
               "x": 361.218,
               "y": 336.03137
          },
          {
               "x": 358.8088,
               "y": 340.37897
          },
          {
               "x": 357.2439,
               "y": 344.12445
          },
          {
               "x": 354.85608,
               "y": 350.0766
          },
          {
               "x": 353.1287,
               "y": 354.7389
          },
          {
               "x": 351.58167,
               "y": 359.45276
          },
          {
               "x": 350.01987,
               "y": 365.56384
          },
          {
               "x": 348.4417,
               "y": 370.8811
          },
          {
               "x": 347.51733,
               "y": 375.09967
          },
          {
               "x": 346.33212,
               "y": 378.95117
          },
          {
               "x": 346.51874,
               "y": 382.799
          },
          {
               "x": 345.22644,
               "y": 386.1599
          },
          {
               "x": 345.5201,
               "y": 390.13
          },
          {
               "x": 345.5201,
               "y": 393.3902
          },
          {
               "x": 345.5201,
               "y": 396.48932
          },
          {
               "x": 346.51874,
               "y": 400.61768
          },
          {
               "x": 347.60065,
               "y": 404.8075
          },
          {
               "x": 348.16446,
               "y": 409.1458
          },
          {
               "x": 348.51596,
               "y": 414.19287
          },
          {
               "x": 351.28864,
               "y": 418.87573
          },
          {
               "x": 351.5118,
               "y": 423.52753
          },
          {
               "x": 354.29312,
               "y": 429.21588
          },
          {
               "x": 355.9426,
               "y": 433.84534
          },
          {
               "x": 358.51114,
               "y": 439.56628
          },
          {
               "x": 359.06235,
               "y": 443.771
          },
          {
               "x": 360.60837,
               "y": 449.95868
          },
          {
               "x": 363.84772,
               "y": 456.22308
          },
          {
               "x": 366.97156,
               "y": 463.71423
          },
          {
               "x": 369.10925,
               "y": 469.75024
          },
          {
               "x": 372.2289,
               "y": 477.36517
          },
          {
               "x": 375.3425,
               "y": 484.15472
          },
          {
               "x": 378.42978,
               "y": 493.35406
          },
          {
               "x": 381.55994,
               "y": 500.7069
          },
          {
               "x": 385.25064,
               "y": 511.0456
          },
          {
               "x": 388.7686,
               "y": 520.3925
          },
          {
               "x": 390.8743,
               "y": 530.7103
          },
          {
               "x": 394.0123,
               "y": 540.13
          },
          {
               "x": 396.29025,
               "y": 550.328
          },
          {
               "x": 399.23807,
               "y": 559.81366
          },
          {
               "x": 401.4041,
               "y": 569.1984
          },
          {
               "x": 402.94037,
               "y": 578.4215
          },
          {
               "x": 405.5708,
               "y": 586.75024
          },
          {
               "x": 408.05063,
               "y": 595.1126
          },
          {
               "x": 409.63028,
               "y": 604.5962
          },
          {
               "x": 411.9468,
               "y": 612.19257
          },
          {
               "x": 413.74167,
               "y": 619.9706
          },
          {
               "x": 416.1951,
               "y": 625.9308
          },
          {
               "x": 417.8605,
               "y": 633.58276
          },
          {
               "x": 418.41013,
               "y": 639.3388
          },
          {
               "x": 419.97232,
               "y": 645.03625
          },
          {
               "x": 420.4161,
               "y": 650.79956
          },
          {
               "x": 422.08127,
               "y": 655.0317
          },
          {
               "x": 422.41333,
               "y": 660.0815
          },
          {
               "x": 423.41193,
               "y": 663.76117
          },
          {
               "x": 424.76102,
               "y": 667.0542
          },
          {
               "x": 424.41055,
               "y": 672.0896
          },
          {
               "x": 424.41055,
               "y": 675.2786
          },
          {
               "x": 425.40915,
               "y": 680.39276
          },
          {
               "x": 426.40778,
               "y": 685.6972
          },
          {
               "x": 426.40778,
               "y": 689.6208
          },
          {
               "x": 426.40778,
               "y": 693.7159
          },
          {
               "x": 427.68234,
               "y": 698.15704
          },
          {
               "x": 427.4064,
               "y": 701.1636
          },
          {
               "x": 427.4064,
               "y": 705.517
          },
          {
               "x": 427.4064,
               "y": 708.2276
          },
          {
               "x": 428.405,
               "y": 711.86145
          },
          {
               "x": 428.405,
               "y": 715.45526
          },
          {
               "x": 429.40363,
               "y": 717.57825
          },
          {
               "x": 429.40363,
               "y": 719.4972
          },
          {
               "x": 429.40363,
               "y": 722.0426
          },
          {
               "x": 430.71738,
               "y": 723.6237
          }
     ]
]
